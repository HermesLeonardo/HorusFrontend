import { Component, OnInit } from '@angular/core';
import { MessageService, ConfirmationService } from 'primeng/api';
import { Projeto, ProjetoVisualizacao } from '../../core/model/projeto.model';
import { ProjetosService } from '../../core/services/projetos.service';
import { UsuariosService } from '../../core/services/usuarios.service';
import { Usuario } from '../../core/model/usuario.model';
import { TableModule } from 'primeng/table';
import { DropdownModule } from 'primeng/dropdown';
import { FormsModule } from '@angular/forms';
import { CommonModule } from '@angular/common';
import { DialogModule } from 'primeng/dialog';
import { ConfirmDialogModule } from 'primeng/confirmdialog';
import { ButtonModule } from 'primeng/button';
import { ToastModule } from 'primeng/toast';
import { MultiSelectModule } from 'primeng/multiselect';
import { ListboxModule } from 'primeng/listbox';
import { CardModule } from 'primeng/card';
import { AuthService } from '../../core/services/auth.service';


@Component({
  selector: 'app-projetos',
  templateUrl: './projetos.component.html',
  styleUrls: ['./projetos.component.scss'],
  providers: [MessageService, ConfirmationService],
  standalone: true,
  imports: [
    CommonModule,
    FormsModule,
    TableModule,
    DropdownModule,
    DialogModule,
    ConfirmDialogModule,
    ButtonModule,
    ToastModule,
    MultiSelectModule,
    ListboxModule,
    CardModule,
  ]
})
export class ProjetosComponent implements OnInit {
  projetos: Projeto[] = [];
  projetosFiltrados: Projeto[] = [];
  projetoSelecionado: Projeto = this.novoProjeto();
  usuariosOptions: { label: string; value: number }[] = [];
  exibirDialog: boolean = false;
  usuarios: Usuario[] = [];
  adminsOptions: { label: string; value: number }[] = [];
  admins: Array<{ label: string; value: number }> = [];
  userRole: string = ''; 




  projetoVisualizacao: ProjetoVisualizacao = {
    id: 0,
    nome: '',
    descricao: '',
    status: 'PLANEJADO',
    prioridade: 'MEDIA',
    idUsuarioResponsavel: [],
    dataInicio: '',
    dataFim: '',
    dataInicioFormatada: '',
    dataFimFormatada: '',
    nomesUsuariosResponsaveis: '',
    atividades: [],
  };
  exibirVisualizacao: boolean = false;

  filtro = { nome: '', status: null, prioridade: null };

  statusOptions = [
    { label: 'Planejamento', value: 'PLANEJADO' },
    { label: 'Em andamento', value: 'EM_ANDAMENTO' },
    { label: 'Conclu√≠do', value: 'CONCLUIDO' },
    { label: 'Cancelado', value: 'CANCELADO' }
  ];

  prioridadeOptions = [
    { label: 'Alta', value: 'ALTA' },
    { label: 'M√©dia', value: 'MEDIA' },
    { label: 'Baixa', value: 'BAIXA' }
  ];

  constructor(
    private projetosService: ProjetosService,
    private usuariosService: UsuariosService,
    private messageService: MessageService,
    private confirmationService: ConfirmationService,
    private authService: AuthService
  ) { }

  ngOnInit(): void {
    this.userRole = this.authService.getUserRole();
    this.carregarProjetos();
    this.carregarUsuarios();
  }

  carregarUsuarios(): void {
    console.log("üì¢ Buscando usu√°rios...");
  
    this.usuariosService.getUsuarios().subscribe(
      (usuarios) => {
        console.log("‚úÖ Usu√°rios carregados com sucesso:", usuarios);
  
        this.usuarios = usuarios;
  
        // üîπ Adiciona o perfil ao label para exibi√ß√£o no dropdown
        this.usuariosOptions = usuarios.map(user => ({
          label: `${user.nome} (${user.perfil === 'ADMIN' ? 'Administrador' : 'Usu√°rio'})`,
          value: user.id
        }));
  
        console.log("üéØ Todos os usu√°rios carregados:", this.usuariosOptions);
      },
      (error) => {
        console.error("‚ùå Erro ao carregar usu√°rios:", error);
        this.messageService.add({ severity: 'error', summary: 'Erro', detail: 'Erro ao carregar usu√°rios!' });
      }
    );
  }
  


  atualizarAdminsResponsaveis(): void {
    console.log("üîÑ Atualizando lista de Admins dispon√≠veis...");

    if (!this.projetoSelecionado.idUsuarioResponsavel) {
      this.projetoSelecionado.idUsuarioResponsavel = [];
    }

    // üîπ Filtra os usu√°rios que s√£o ADMIN e que foram selecionados no campo anterior
    const adminsSelecionados = this.usuarios.filter(user =>
      user.perfil === 'ADMIN' && (this.projetoSelecionado.idUsuarioResponsavel ?? []).includes(user.id)
    );


    // üîπ Atualiza a lista de admins dispon√≠veis
    this.adminsOptions = adminsSelecionados.map(admin => ({
      label: admin.nome,
      value: admin.id
    }));

    console.log("‚úÖ Admins dispon√≠veis para sele√ß√£o:", this.adminsOptions);
  }





  abrirDialog(projeto?: Projeto): void {
    if (projeto) {
      this.projetoSelecionado = { ...projeto };

      this.projetoSelecionado.dataInicio = projeto.dataInicio
        ? new Date(projeto.dataInicio).toISOString().split('T')[0]
        : '';
      this.projetoSelecionado.dataFim = projeto.dataFim
        ? new Date(projeto.dataFim).toISOString().split('T')[0]
        : '';

      // üîπ Garante que os arrays n√£o sejam undefined
      this.projetoSelecionado.idUsuarioResponsavel = projeto.idUsuarioResponsavel ?? [];
    } else {
      this.projetoSelecionado = this.novoProjeto();
    }

    this.atualizarAdminsResponsaveis(); // Atualiza admins dispon√≠veis
    this.exibirDialog = true;
  }




  fecharDialog(): void {
    this.exibirDialog = false;
  }

  salvarProjeto(): void {
    if (!this.projetoSelecionado) {
      console.error("üö® Nenhum projeto foi selecionado!");
      return;
    }

    const usuariosIds = this.projetoSelecionado.idUsuarioResponsavel
      ? [...this.projetoSelecionado.idUsuarioResponsavel]
      : [];

    console.log("üìå IDs dos usu√°rios extra√≠dos para envio:", usuariosIds);



    const novoProjeto = {
      projeto: {
        ...this.projetoSelecionado,
        status: typeof this.projetoSelecionado.status === 'object'
          ? this.projetoSelecionado.status.value
          : this.projetoSelecionado.status,
        prioridade: typeof this.projetoSelecionado.prioridade === 'object'
          ? this.projetoSelecionado.prioridade.value
          : this.projetoSelecionado.prioridade
      },
      usuariosIds: this.projetoSelecionado.idUsuarioResponsavel ?? [], // üîπ Agora envia os IDs corretamente
      idUsuarioResponsavel: this.projetoSelecionado.idUsuarioResponsavel?.find(id => {
        const user = this.usuarios.find(u => u.id === id);
        return user?.perfil === 'ADMIN';
      }) || null
    };

    console.log("üìå JSON corrigido antes do envio:", JSON.stringify(novoProjeto, null, 2));




    if (this.projetoSelecionado.id) {
      this.projetosService.atualizarProjeto(
        this.projetoSelecionado.id,
        novoProjeto.projeto,
        novoProjeto.usuariosIds,
        novoProjeto.idUsuarioResponsavel ?? 0
      ).subscribe(() => {
        this.carregarProjetos();
        this.messageService.add({ severity: 'success', summary: 'Sucesso', detail: 'Projeto atualizado com sucesso!' });
        this.fecharDialog();
      }, (error) => {
        console.error("‚ùå Erro ao atualizar o projeto:", error);
        this.messageService.add({ severity: 'error', summary: 'Erro', detail: 'Erro ao atualizar o projeto!' });
      });
    } else {
      this.projetosService.salvarProjeto(novoProjeto)
        .subscribe(() => {
          this.carregarProjetos();
          this.messageService.add({ severity: 'success', summary: 'Sucesso', detail: 'Projeto salvo com sucesso!' });
          this.fecharDialog();
        }, (error) => {
          console.error("‚ùå Erro ao salvar o projeto:", error);
          this.messageService.add({ severity: 'error', summary: 'Erro', detail: 'Erro ao salvar o projeto!' });
        });
    }

  }




  visualizarProjeto(projeto: Projeto): void {
    const usuariosIds = projeto.usuarios ? projeto.usuarios.map(user => user.id) : [];

    // üîπ Filtra os usu√°rios com base nos IDs e gera os nomes corretamente
    const usuariosNomes = this.usuarios
      .filter(user => usuariosIds.includes(user.id)) // ‚úÖ Agora sempre ser√° um array v√°lido
      .map(user => user.nome)
      .join(', ');

    this.projetoVisualizacao = {
      ...projeto,
      dataInicioFormatada: projeto.dataInicio ? new Date(projeto.dataInicio).toLocaleDateString() : 'N√£o definido',
      dataFimFormatada: projeto.dataFim ? new Date(projeto.dataFim).toLocaleDateString() : 'N√£o definido',
      nomesUsuariosResponsaveis: usuariosNomes,
      usuarios: projeto.usuarios || []  // üîπ Agora os usu√°rios ser√£o passados corretamente para o HTML
    };

    this.exibirVisualizacao = true;
    console.log("‚úÖ Modal de visualiza√ß√£o aberto!");
  }




  fecharVisualizacao(): void {
    this.exibirVisualizacao = false;
  }

  confirmarExclusao(projeto: Projeto): void {
    this.confirmationService.confirm({
      message: `Tem certeza que deseja excluir o projeto "${projeto.nome}"? Esta a√ß√£o n√£o pode ser desfeita!`,
      acceptLabel: "Sim, Excluir",
      rejectLabel: "Cancelar",
      icon: "pi pi-exclamation-triangle",
      accept: () => {
        this.projetosService.excluirProjeto(projeto.id).subscribe(() => {
          this.carregarProjetos();
          this.messageService.add({
            severity: 'success',
            summary: 'Sucesso',
            detail: 'Projeto exclu√≠do com sucesso!'
          });
        },
          (error) => {
            console.error("Erro ao excluir projeto:", error);
            this.messageService.add({
              severity: 'error',
              summary: 'Erro',
              detail: 'N√£o foi poss√≠vel excluir o projeto.'
            });
          });
      }
    });
  }


  carregarProjetos(): void {
    const userRole = localStorage.getItem('userRole');
  
    if (userRole === 'ROLE_ADMIN') {
      this.projetosService.getProjetos().subscribe(
        (data) => {
          console.log("üì• Projetos recebidos (ADMIN):", data);
          this.projetos = data;
          this.filtrarProjetos();
        },
        (error) => {
          console.error("‚ùå Erro ao carregar projetos!", error);
        }
      );
    } else {
      this.projetosService.getProjetos().subscribe( // ‚úÖ Agora chama o endpoint correto para usu√°rio comum
        (data) => {
          console.log("üì• Projetos recebidos (USU√ÅRIO):", data);
          this.projetos = data;
          this.filtrarProjetos();
        },
        (error) => {
          console.error("‚ùå Erro ao carregar projetos para usu√°rio!", error);
        }
      );
    }
  }
  


  filtrarProjetos(): void {
    this.projetosFiltrados = this.projetos.filter(p =>
      (this.filtro.nome ? p.nome.toLowerCase().includes(this.filtro.nome.toLowerCase()) : true) &&
      (this.filtro.status !== null ? p.status === this.filtro.status : true) &&
      (this.filtro.prioridade !== null ? p.prioridade === this.filtro.prioridade : true)
    );
  }

  resetarFiltros(): void {
    this.filtro = { nome: '', status: null, prioridade: null };
    this.filtrarProjetos();
  }

  novoProjeto(): Projeto {
    return {
      id: 0,
      nome: '',
      descricao: '',
      status: 'PLANEJADO',
      prioridade: 'MEDIA',
      idUsuarioResponsavel: [],
      dataInicio: new Date(),
      dataFim: undefined,
      atividades: []
    };
  }
}
